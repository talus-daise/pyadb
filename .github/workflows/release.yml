name: Build & Release PyADB

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    windows:
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install deps
              run: pip install -r requirements.txt

            - name: Download adb
              run: |
                  curl -L -o platform-tools.zip https://dl.google.com/android/repository/platform-tools-latest-windows.zip
                  tar -xf platform-tools.zip
                  copy platform-tools\adb.exe .

            - name: Build
              run: |
                  pyinstaller --onefile --windowed --name PyADB --add-binary "adb.exe;." app.py
                  mkdir release
                  move dist\PyADB.exe release\
                  copy adb.exe release\
                  cd release
                  tar -a -c -f PyADB-${{ github.ref_name }}-windows.zip *

            - uses: softprops/action-gh-release@v2
              with:
                  files: release/PyADB-${{ github.ref_name }}-windows.zip

    macos:
        runs-on: macos-latest
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Install deps
              run: pip install -r requirements.txt

            - name: Download adb
              run: |
                  curl -LO https://dl.google.com/android/repository/platform-tools-latest-darwin.zip
                  unzip platform-tools-latest-darwin.zip
                  cp platform-tools/adb .

            - name: Build
              run: |
                  pyinstaller --onefile --windowed --name PyADB \
                    --add-binary "adb:." \
                    app.py
                  cd dist
                  zip -r PyADB-${{ github.ref_name }}-macos.zip PyADB.app

            - uses: softprops/action-gh-release@v2
              with:
                  files: dist/PyADB-${{ github.ref_name }}-macos.zip

    linux:
        runs-on: ubuntu-22.04
        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-python@v5
              with:
                python-version: "3.11"

            - name: Install system deps
              run: |
                sudo apt update
                sudo apt install -y \
                python3-dev build-essential fakeroot patchelf dpkg imagemagick squashfs-tools

            - name: Install python deps
              run: pip install -r requirements.txt
            
            - name: Download adb
              run: |
                curl -LO https://dl.google.com/android/repository/platform-tools-latest-linux.zip
                unzip platform-tools-latest-linux.zip
                cp platform-tools/adb .
                chmod +x adb

            - name: Build binary
              run: |
                pyinstaller --onefile --windowed --name PyADB \
                    --add-binary "adb:." \
                    app.py

            # -----------------------
            # deb パッケージ作成
            # -----------------------
            - name: Build deb package
              run: |
                VERSION=${{ github.ref_name }}
                VERSION=${VERSION#v}

                mkdir -p pkg/DEBIAN
                mkdir -p pkg/usr/bin

                cp dist/PyADB pkg/usr/bin/pyadb

                cat > pkg/DEBIAN/control <<EOF
                Package: pyadb
                Version: ${VERSION}
                Section: utils
                Priority: optional
                Architecture: amd64
                Depends: python3, python3-pyside6, android-tools-adb
                Maintainer: PyADB
                Description: PyADB GUI tool
                 PyADB is a simple GUI frontend for Android Debug Bridge.
                EOF

                dpkg-deb --build pkg PyADB-${{ github.ref_name }}-linux.deb

            - name: Set up AppImage Builder
              uses: AppImageCrafters/build-appimage-action@v1

            - name: Build AppImage
              uses: AppImageCrafters/build-appimage-action@master
              env:
                VERSION: ${{ github.ref_name }}
              with:
                recipe: appimage-builder.yml


            # -----------------------
            # Release
            # -----------------------
            - uses: softprops/action-gh-release@v2
              with:
                files: |
                    *.AppImage